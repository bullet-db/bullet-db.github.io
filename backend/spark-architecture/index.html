<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The full documentation for Bullet - A Real Time Data Query Engine"> 
    <meta name="author" content="Akshai Sarma"> 
    <link rel="canonical" href="https://bullet-db.github.io/backend/spark-architecture/"> 
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>Architecture - Bullet Docs</title>

    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/extra.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    

    
    
      
    
    
    <style>
        /* Collapse ToC */
        .bs-sidebar .nav .nav {
            display: none;
        }
    </style>
    
</head>

<body data-spy="scroll" data-target=".bs-sidebar">

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Bullet Docs<small class="small small-brand-text">v0.6.0</small></a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Quick Start <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../quick-start/spark/">Spark</a>
</li>

                        
                            
<li >
    <a href="../../quick-start/storm/">Storm</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Backend <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Data Ingestion</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../ingestion/">Record Container</a>
</li>

        
            
<li >
    <a href="../dsl/">DSL</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Storm</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../storm-architecture/">Architecture</a>
</li>

        
            
<li >
    <a href="../storm-setup/">Setup</a>
</li>

        
            
<li >
    <a href="../storm-performance/">Performance</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Spark</a>
    <ul class="dropdown-menu">
        
            
<li class="active">
    <a href="./">Architecture</a>
</li>

        
            
<li >
    <a href="../spark-setup/">Setup</a>
</li>

        
            
<li >
    <a href="../spark-performance/">Performance</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">PubSub <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../pubsub/architecture/">Architecture</a>
</li>

                        
                            
<li >
    <a href="../../pubsub/kafka/">Kafka</a>
</li>

                        
                            
<li >
    <a href="../../pubsub/rest/">REST</a>
</li>

                        
                            
<li >
    <a href="../../pubsub/pulsar/">Pulsar</a>
</li>

                        
                            
<li >
    <a href="../../pubsub/storm-drpc/">Storm DRPC</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Web Service <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../ws/setup/">Setup</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">API</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../ws/api-bql/">BQL</a>
</li>

        
            
<li >
    <a href="../../ws/api-json/">JSON</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../ws/examples/">Query Examples</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">UI <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../ui/setup/">Setup</a>
</li>

                        
                            
<li >
    <a href="../../ui/usage/">Usage</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../releases/">Releases</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../about/contributing/">Contributing</a>
</li>

                        
                            
<li >
    <a href="../../about/contact/">Contact Us</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fa fa-search"></i> Search
                        </a>
                  </li>
                
                
                    <li >
                        <a rel="next" href="../storm-performance/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../spark-setup/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/bullet-db">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3">

  

<div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="active">
            <a href="#spark-architecture">Spark architecture</a>
            <ul class="nav">
                
                    <li class="second-level">
                        <a href="#data-flow-graph">Data Flow Graph</a>
                        <ul class="nav">
                        
                            <li class="third-level">
                                <a href="#data-processing">Data processing</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#request-processing">Request processing</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#combining">Combining</a>
                                
                            </li>
                        
                        </ul>
                    </li>
            
            </ul>
        </li>
    
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="spark-architecture">Spark architecture</h1>
<p>This section describes how the <a href="../..#backend">Backend architecture</a> is implemented in Spark Streaming.</p>
<h2 id="data-flow-graph">Data Flow Graph</h2>
<p>Bullet Spark implements the backend piece from the full <a href="../..#architecture">Architecture</a>. It is implemented with Spark Streaming:</p>
<p><img alt="Bullet Spark DAG" src="../../img/spark-dag.png" /></p>
<p>The components in the <a href="../..#architecture">Architecture</a> have direct counterparts here. The Query Receiver reading from the PubSub layer using plugged-in PubSub consumers and the Query Unioning make up the Request Processor. The Filter Streaming and your plugin for your source of data make up the Data Processor. The Join Streaming and the Result Emitter make up the Combiner.</p>
<p>The red lines are the path for the queries that come in through the PubSub, the orange lines are the path for the signals and the blue lines are for the data from your data source. The shapes of the boxes denote the type of transformation/action being executed in the boxes.</p>
<h3 id="data-processing">Data processing</h3>
<p>Bullet can accept arbitrary sources of data as long as they can be ingested by Spark. They can be Kafka, Flume, Kinesis, and TCP sockets etc. In order to hook up your data to Bullet Spark, you just need to implement the <a href="https://github.com/bullet-db/bullet-spark/blob/master/src/main/scala/com/yahoo/bullet/spark/DataProducer.scala">Data Producer Trait</a>. In your implementation, you can either:</p>
<ul>
<li>Use <a href="https://spark.apache.org/docs/latest/streaming-programming-guide.html#input-dstreams-and-receivers">Spark Streaming built-in sources</a> to receive data. Below is a quick example for a direct Kafka source in Scala. You can also write it in Java:</li>
</ul>
<pre><code class="scala">import com.yahoo.bullet.spark.DataProducer
import org.apache.spark.streaming.kafka010.{ConsumerStrategies, KafkaUtils, LocationStrategies}
// import all other necessary packages

class DirectKafkaProducer extends DataProducer {
  override def getBulletRecordStream(ssc: StreamingContext, config: BulletSparkConfig): DStream[BulletRecord] = {
    val topics = Array(&quot;test&quot;)
    val kafkaParams = Map[String, AnyRef](
      &quot;bootstrap.servers&quot; -&gt; &quot;server1, server2&quot;,
      &quot;group.id&quot; -&gt; &quot;mygroup&quot;,
      &quot;key.deserializer&quot; -&gt; classOf[StringDeserializer],
      &quot;value.deserializer&quot; -&gt; classOf[ByteArrayDeserializer]
      // Other kafka params
      )

    val directKafkaStream = KafkaUtils.createDirectStream[String, Array[Byte]](
      ssc,
      LocationStrategies.PreferConsistent,
      ConsumerStrategies.Subscribe[String, Array[Byte]](topics, kafkaParams))

    directKafkaStream.map(record =&gt; {
      // Convert your record to BulletRecord
    })
  }
}
</code></pre>

<ul>
<li>Write a <a href="https://spark.apache.org/docs/latest/streaming-custom-receivers.html">custom receiver</a> to receive data from any arbitrary data source beyond the ones for which it has built-in support (that is, beyond Flume, Kafka, Kinesis, files, sockets, etc.). See <a href="https://github.com/bullet-db/bullet-db.github.io/tree/src/examples/spark/src/main/scala/com/yahoo/bullet/spark/examples">example</a>.</li>
</ul>
<p>After receiving your data, you can do any transformations like joins or type conversions in your implementation before emitting to the Filter Streaming stage.</p>
<p>The Filter Streaming stage checks every record from your data source against every query from Query Unioning stage to see if it matches and emits partial results to the Join Streaming stage.</p>
<h3 id="request-processing">Request processing</h3>
<p>The Query Receiver fetches Bullet queries and signals through the PubSub layer using the Subscribers provided by the plugged in PubSub layer. The queries received through the PubSub also contain information about the query such as its unique identifier, potentially other metadata and signals. The Query Unioning collects all active queries by the stateful transformation <a href="https://spark.apache.org/docs/latest/streaming-programming-guide.html#updatestatebykey-operation">updateStateByKey</a> and broadcasts all the collected queries to every executor for the Filter Streaming stage.</p>
<p>The Query Unioning also sends all active queries and signals to the Join Streaming stage.</p>
<h3 id="combining">Combining</h3>
<p>The Filter Streaming combines all the partial results from the Filter Streaming by the stateful transformation <a href="https://spark.apache.org/docs/2.3.0/api/scala/index.html#org.apache.spark.streaming.dstream.PairDStreamFunctions@mapWithState[StateType,MappedType](spec:org.apache.spark.streaming.StateSpec[K,V,StateType,MappedType])(implicitevidence$2:scala.reflect.ClassTag[StateType],implicitevidence$3:scala.reflect.ClassTag[MappedType]):org.apache.spark.streaming.dstream.MapWithStateDStream[K,V,StateType,MappedType]">mapWithState</a> and produces final results.</p>
<p>The Result Emitter uses the particular publisher from the plugged in PubSub layer to send back results/loop signals.</p></div>
        
    </div>

    <footer class="col-md-12" >
        <hr />
        <div class="pull-left col-md-6">
            
            
        </div>
        <div class="pull-right col-md-4 text-right">
            <p>
            <small>Bullet is licensed under the <a href='https://github.com/bullet-db/bullet-core/blob/master/LICENSE'>Apache 2 license</a>.<br></small>
            
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
        </div>
    </footer>

    <script src="../../js/jquery-1.10.2.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '../..';
    </script>
    <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
    <script src="../../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
