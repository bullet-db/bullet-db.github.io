<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The full documentation for Bullet - A Real Time Data Query Engine"> 
    <meta name="author" content="Akshai Sarma"> 
    <link rel="canonical" href="https://bullet-db.github.io/backend/spark-performance/"> 
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>Performance - Bullet Docs</title>

    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/extra.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    

    
    
      
    
    
    <style>
        /* Collapse ToC */
        .bs-sidebar .nav .nav {
            display: none;
        }
    </style>
    
</head>

<body data-spy="scroll" data-target=".bs-sidebar">

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Bullet Docs<small class="small small-brand-text">v0.5.2</small></a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Quick Start <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../quick-start/spark/">Spark</a>
</li>

                        
                            
<li >
    <a href="../../quick-start/storm/">Storm</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Backend <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../ingestion/">Getting your data into Bullet</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Storm</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../storm-architecture/">Architecture</a>
</li>

        
            
<li >
    <a href="../storm-setup/">Setup</a>
</li>

        
            
<li >
    <a href="../storm-performance/">Performance</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Spark</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../spark-architecture/">Architecture</a>
</li>

        
            
<li >
    <a href="../spark-setup/">Setup</a>
</li>

        
            
<li class="active">
    <a href="./">Performance</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">PubSub <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../pubsub/architecture/">Architecture</a>
</li>

                        
                            
<li >
    <a href="../../pubsub/kafka/">Kafka</a>
</li>

                        
                            
<li >
    <a href="../../pubsub/rest/">REST</a>
</li>

                        
                            
<li >
    <a href="../../pubsub/storm-drpc/">Storm DRPC</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Web Service <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../ws/setup/">Setup</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">API</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../ws/api-json/">JSON</a>
</li>

        
            
<li >
    <a href="../../ws/api-bql/">BQL</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../ws/examples/">Query Examples</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">UI <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../ui/setup/">Setup</a>
</li>

                        
                            
<li >
    <a href="../../ui/usage/">Usage</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../releases/">Releases</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../about/contributing/">Contributing</a>
</li>

                        
                            
<li >
    <a href="../../about/contact/">Contact Us</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fa fa-search"></i> Search
                        </a>
                  </li>
                
                
                    <li>
                        <a href="https://github.com/bullet-db">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3">

  

<div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="active">
            <a href="#performance-of-bullet-on-spark">Performance of Bullet on Spark</a>
            <ul class="nav">
                
                    <li class="second-level">
                        <a href="#prerequisites">Prerequisites</a>
                        
                    </li>
            
                    <li class="second-level">
                        <a href="#how-was-this-tested">How was this tested?</a>
                        <ul class="nav">
                        
                            <li class="third-level">
                                <a href="#tools-used">Tools used</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#cluster">Cluster</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#data">Data</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#configuration">Configuration</a>
                                
                            </li>
                        
                        </ul>
                    </li>
            
                    <li class="second-level">
                        <a href="#test-1-latency-of-bullet-spark">Test 1: Latency of Bullet Spark</a>
                        <ul class="nav">
                        
                            <li class="third-level">
                                <a href="#result">Result</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#conclusion">Conclusion</a>
                                
                            </li>
                        
                        </ul>
                    </li>
            
                    <li class="second-level">
                        <a href="#test-2-scalability-for-smaller-data">Test 2: Scalability for smaller data</a>
                        <ul class="nav">
                        
                            <li class="third-level">
                                <a href="#result_1">Result</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#conclusion_1">Conclusion</a>
                                
                            </li>
                        
                        </ul>
                    </li>
            
                    <li class="second-level">
                        <a href="#test-3-scalability-for-larger-data">Test 3: Scalability for larger data</a>
                        <ul class="nav">
                        
                            <li class="third-level">
                                <a href="#result_2">Result</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#conclusion_2">Conclusion</a>
                                
                            </li>
                        
                        </ul>
                    </li>
            
            </ul>
        </li>
    
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="performance-of-bullet-on-spark">Performance of Bullet on Spark</h1>
<p>This section describes how we tune the performance of Bullet on Spark. This is not meant to be a rigorous benchmark.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>You should be familiar with <a href="https://spark.apache.org/streaming/">Spark Streaming</a>, <a href="http://kafka.apache.org">Kafka</a> and the <a href="../spark-architecture/">Bullet on Spark architecture</a>.</p>
<h2 id="how-was-this-tested">How was this tested?</h2>
<p>All tests run here were using <a href="https://github.com/bullet-db/bullet-spark/releases/tag/bullet-spark-0.1.2">Bullet-Spark 0.1.2</a>.</p>
<h3 id="tools-used">Tools used</h3>
<ul>
<li><a href="https://stedolan.github.io/jq/">jq</a> - a nice tool to parse Bullet JSON responses</li>
<li>curl, bash and python - for running and analyzing Bullet queries</li>
<li><a href="https://jmeter.apache.org/">Apache JMeter</a> - a load testing tool to send multiple queries to the server simultaneously</li>
</ul>
<h3 id="cluster">Cluster</h3>
<ul>
<li>Hadoop YARN cluster with Apache Spark 2.1.2.12 installed</li>
<li>The spec for the machines we were running on:<ul>
<li>2 x Intel E5530(4 cores, 8 Threads)</li>
<li>24 GB RAM</li>
<li>3 TB SATA Disk</li>
<li>10 G Network Interface</li>
</ul>
</li>
</ul>
<h3 id="data">Data</h3>
<ul>
<li>Our data was read from a Kafka cluster. Kafka version is 0.10.2.1</li>
<li>The Kafka cluster was located within the same datacenter as the Hadoop YARN cluster - close network proximity gives us some measure of confidence that large data transmission delays aren't a factor.</li>
<li>Our data schema contained <code>92</code> fields with <code>62</code> Strings, <code>4</code> Longs, <code>23</code> Maps and <code>3</code> Lists of Maps. Most of the data is generally present in the Maps and Lists of Maps.</li>
<li>We tested 2 set of data:<ul>
<li>The smaller data was about 36,000 records/s and 43 MB/s</li>
<li>The larger data was about 124,700 records/s and 150 MB/s</li>
</ul>
</li>
</ul>
<h3 id="configuration">Configuration</h3>
<p>Here are the configurations we used to launch instances of Bullet Spark.</p>
<ul>
<li>For the smaller data:</li>
</ul>
<p>Settings:</p>
<pre><code class="YAML">bullet.spark.batch.duration.ms: 2000
bullet.spark.receiver.query.block.size: 1
bullet.result.metadata.enable: true
bullet.spark.metrics.enabled: true
bullet.spark.filter.parallel.enabled: true
bullet.spark.filter.parallelism: 16
bullet.spark.filter.parallel.query.min.size: 10
bullet.spark.query.union.checkpoint.duration.multiplier: 20
bullet.spark.join.checkpoint.duration.multiplier: 20
</code></pre>

<p>Command line:</p>
<pre><code class="bash">./spark-submit \
  --master yarn \
  --deploy-mode cluster \
  --queue default \
  --executor-memory 12g \
  --executor-cores 2 \
  --num-executors 100 \
  --driver-cores 2 \
  --driver-memory 12g \
  --conf spark.streaming.backpressure.enabled=true \
  --conf spark.driver.extraJavaOptions=&quot;-XX:+UseG1GC&quot; \
  --conf spark.executor.extraJavaOptions=&quot;-XX:+UseG1GC&quot; \
  --conf spark.shuffle.consolidateFiles=true \
  --conf spark.dynamicAllocation.enabled=false \
  --conf spark.storage.memoryFraction=0.1 \
  --conf spark.shuffle.memoryFraction=0.8 \
  --conf spark.default.parallelism=20 \
  ...
</code></pre>

<ul>
<li>For larger Data:</li>
</ul>
<p>Settings:</p>
<pre><code class="YAML">bullet.spark.batch.duration.ms: 5000
bullet.spark.receiver.query.block.size: 1
bullet.result.metadata.enable: true
bullet.spark.metrics.enabled: true
bullet.spark.filter.parallel.enabled: true
bullet.spark.filter.parallelism: 64
bullet.spark.filter.parallel.query.min.size: 10
bullet.spark.query.union.checkpoint.duration.multiplier: 20
bullet.spark.join.checkpoint.duration.multiplier: 20
</code></pre>

<p>Command line:</p>
<pre><code class="bash">./spark-submit \
  --master yarn \
  --deploy-mode cluster \
  --queue default \
  --executor-memory 12g \
  --executor-cores 2 \
  --num-executors 400 \
  --driver-cores 2 \
  --driver-memory 12g \
  --conf spark.streaming.backpressure.enabled=true \
  --conf spark.driver.extraJavaOptions=&quot;-XX:+UseG1GC&quot; \
  --conf spark.executor.extraJavaOptions=&quot;-XX:+UseG1GC&quot; \
  --conf spark.shuffle.consolidateFiles=true \
  --conf spark.dynamicAllocation.enabled=false \
  --conf spark.storage.memoryFraction=0.1 \
  --conf spark.shuffle.memoryFraction=0.8 \
  --conf spark.default.parallelism=50 \
  ...
</code></pre>

<h2 id="test-1-latency-of-bullet-spark">Test 1: Latency of Bullet Spark</h2>
<p>This test was done on the smaller data. We used a <a href="../../ws/examples/#simplest-query">RAW query without any filtering</a> to measure the latency added by Bullet Spark. This is not the end-to-end latency for a query. It is the latency from receiving the query to finishing the query, not including the time spent in Kafka. We ran this query 100 times.</p>
<h3 id="result">Result</h3>
<p>This graph shows the latency of each attempt:</p>
<p><img alt="Bullet Spark Latency" src="../../img/spark-perf-latency.png" /></p>
<h3 id="conclusion">Conclusion</h3>
<p>The average latency was 1173 ms. This result shows that this is the fastest Bullet Spark can be. It cannot return data any faster than this for meaningful queries.</p>
<h2 id="test-2-scalability-for-smaller-data">Test 2: Scalability for smaller data</h2>
<p>This test was done on the smaller data. We want to measure how many queries we can have running simultaneously on Bullet Spark. We ran 400, 800, 1500 and 1100 queries each for 10 minutes.</p>
<h3 id="result_1">Result</h3>
<h4 id="figure-1-spark-streaming-ui">Figure 1. Spark Streaming UI</h4>
<p><img alt="ui" src="../../img/spark-perf-1-ui.png" /></p>
<h4 id="figure-2-queries-running">Figure 2. Queries running</h4>
<p><img alt="Queries" src="../../img/spark-perf-1-queryrunning.png" /></p>
<h4 id="figure-3-cpu-time">Figure 3. CPU time</h4>
<p><img alt="cpu" src="../../img/spark-perf-1-cpu-time.png" /></p>
<h4 id="figure-4-heap-usage">Figure 4. Heap usage</h4>
<p><img alt="heap" src="../../img/spark-perf-1-heap.png" /></p>
<h4 id="figure-5-garbage-collection-time">Figure 5. Garbage collection time</h4>
<p><img alt="gc time" src="../../img/spark-perf-1-gc-time.png" /></p>
<h4 id="figure-6-garbage-collection-count">Figure 6. Garbage collection count</h4>
<p><img alt="gc count" src="../../img/spark-perf-1-gc-count.png" /></p>
<p><a href="#figure-1-spark-streaming-ui">Figure 1</a> shows the Spark Streaming UI when running the test.</p>
<p><a href="#figure-2-queries-running">Figure 2</a> shows the simultaneous queries we ran.</p>
<p><a href="#figure-3-cpu-time">Figure 3</a> shows the milliseconds of CPU time used per minute. For example, a value of <code>300K ms</code> ms for a line (worker) means that the worker used <code>300K ms/min</code>  or <code>300s/60s</code> or <code>5</code> CPU cores (virtual) in that minute.</p>
<p><a href="#figure-4-heap-usage">Figure 4</a> shows raw numbers for Heap utilizations in bytes.</p>
<p><a href="#figure-5-garbage-collection-time">Figure 5</a> shows the time in milliseconds spent for garbage collection per minute.</p>
<p><a href="#figure-6-garbage-collection-count">Figure 6</a> shows the count of garbage collection events per minute.</p>
<h3 id="conclusion_1">Conclusion</h3>
<p>The average processing time for each batch was 1 second 143 ms which was below the batch duration 2 seconds. On average, 1 CPU core and 3GB memory were used in this experiment. CPU and memory usages go slowly up while queries number goes up but they are still within resource limits. We can easily run up to 1500 RAW queries simultaneously in this test.</p>
<h2 id="test-3-scalability-for-larger-data">Test 3: Scalability for larger data</h2>
<p>This test was done on the larger data. We ran 100, 400, 800 and 600 queries each for 10 minutes.</p>
<h3 id="result_2">Result</h3>
<h4 id="figure-7-spark-stream-ui">Figure 7. Spark stream UI</h4>
<p><img alt="ui" src="../../img/spark-perf-2-ui.png" /></p>
<h4 id="figure-8-queries-running">Figure 8. Queries running</h4>
<p><img alt="Queries" src="../../img/spark-perf-2-queryrunning.png" /></p>
<h4 id="figure-9-cpu-time">Figure 9. CPU time</h4>
<p><img alt="cpu" src="../../img/spark-perf-2-cpu-time.png" /></p>
<h4 id="figure-10-heap-usage">Figure 10. Heap usage</h4>
<p><img alt="heap" src="../../img/spark-perf-2-heap.png" /></p>
<h4 id="figure-11-garbage-collection-time">Figure 11. Garbage collection time</h4>
<p><img alt="gc time" src="../../img/spark-perf-2-gc-time.png" /></p>
<h4 id="figure-12-garbage-collection-count">Figure 12. Garbage collection count</h4>
<p><img alt="gc count" src="../../img/spark-perf-2-gc-count.png" /></p>
<h3 id="conclusion_2">Conclusion</h3>
<p>The average processing time for each batch was 3 seconds 97 ms which was below the batch duration 5 seconds. On average, 1.2 CPU core and average 5GB memory were used in this experiment. But with queries number goes up, some of the executors memory usage were up to 8-10GB which is close to our resource limits. With more queries running, OOM may happen. So in this experiment, we can only afford up to 800 queries simultaneously.</p></div>
        
    </div>

    <footer class="col-md-12" >
        <hr />
        <div class="pull-left col-md-6">
            
            
        </div>
        <div class="pull-right col-md-4 text-right">
            <p>
            <small>Bullet is licensed under the <a href='https://github.com/bullet-db/bullet-core/blob/master/LICENSE'>Apache 2 license</a>.<br></small>
            
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
        </div>
    </footer>

    <script src="../../js/jquery-1.10.2.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '../..';
    </script>
    <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
    <script src="../../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
