<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The full documentation for Bullet - A Real Time Data Query Engine"> 
    <meta name="author" content="Akshai Sarma"> 
    <link rel="canonical" href="https://bullet-db.github.io/pubsub/architecture/"> 
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>Architecture - Bullet Docs</title>

    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/extra.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    

    
    
      
    
    
    <style>
        /* Collapse ToC */
        .bs-sidebar .nav .nav {
            display: none;
        }
    </style>
    
</head>

<body data-spy="scroll" data-target=".bs-sidebar">

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Bullet Docs<small class="small small-brand-text">v1.1.0</small></a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Quick Start <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../quick-start/spark/">Spark</a>
</li>

                        
                            
<li >
    <a href="../../quick-start/storm/">Storm</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Backend <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Data Ingestion</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../backend/ingestion/">Record Container</a>
</li>

        
            
<li >
    <a href="../../backend/dsl/">DSL</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Storm</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../backend/storm-architecture/">Architecture</a>
</li>

        
            
<li >
    <a href="../../backend/storm-setup/">Setup</a>
</li>

        
            
<li >
    <a href="../../backend/storm-performance/">Performance</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Spark</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../backend/spark-architecture/">Architecture</a>
</li>

        
            
<li >
    <a href="../../backend/spark-setup/">Setup</a>
</li>

        
            
<li >
    <a href="../../backend/spark-performance/">Performance</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">PubSub <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li class="active">
    <a href="./">Architecture</a>
</li>

                        
                            
<li >
    <a href="../kafka/">Kafka</a>
</li>

                        
                            
<li >
    <a href="../rest/">REST</a>
</li>

                        
                            
<li >
    <a href="../pulsar/">Pulsar</a>
</li>

                        
                            
<li >
    <a href="../storm-drpc/">Storm DRPC</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Web Service <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../ws/setup/">Setup</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">API</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../ws/api/">BQL</a>
</li>

        
            
<li >
    <a href="../../ws/examples/">Examples</a>
</li>

        
            
<li >
    <a href="../../ws/api-json/">JSON (DEPRECATED)</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">UI <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../ui/setup/">Setup</a>
</li>

                        
                            
<li >
    <a href="../../ui/usage/">Usage</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../releases/">Releases</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../about/contributing/">Contributing</a>
</li>

                        
                            
<li >
    <a href="../../about/contact/">Contact Us</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fa fa-search"></i> Search
                        </a>
                  </li>
                
                
                    <li >
                        <a rel="next" href="../../backend/spark-performance/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../kafka/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/bullet-db">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3">

  

<div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="active">
            <a href="#pubsub-architecture">PubSub Architecture</a>
            <ul class="nav">
                
                    <li class="second-level">
                        <a href="#why-a-pubsub">Why a PubSub?</a>
                        
                    </li>
            
                    <li class="second-level">
                        <a href="#what-does-it-do">What does it do?</a>
                        <ul class="nav">
                        
                            <li class="third-level">
                                <a href="#messages">Messages</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#serde">SerDe</a>
                                
                            </li>
                        
                        </ul>
                    </li>
            
                    <li class="second-level">
                        <a href="#choosing-a-pubsub-implementation">Choosing a PubSub implementation</a>
                        
                    </li>
            
                    <li class="second-level">
                        <a href="#implementing-your-own-pubsub">Implementing your own PubSub</a>
                        <ul class="nav">
                        
                            <li class="third-level">
                                <a href="#reliability">Reliability</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#canonical-example">Canonical example</a>
                                
                            </li>
                        
                        </ul>
                    </li>
            
            </ul>
        </li>
    
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="pubsub-architecture">PubSub Architecture</h1>
<p>This section describes how the Publish-Subscribe or <a href="../..#pubsub">PubSub layer</a> works in Bullet.</p>
<h2 id="why-a-pubsub">Why a PubSub?</h2>
<p>When we initially created Bullet, it was built on <a href="https://storm.apache.org">Apache Storm</a> and leveraged a feature in it called Storm DRPC to deliver queries to and extract results from the Bullet Backend. Storm DRPC is supported by a set of clusters that are physically part of the Storm cluster and is a shared resource for the cluster. While many other stream processors support some form of RPC and we could support multiple versions of the Web Service for those, it quickly became clear that abstracting the transport layer from the Web Service to the Backend was needed. This was particularly highlighted when we wanted to switch Bullet queries from operating in a request-response model (one response at the end of the query) to a streaming model. Streaming responses back to the user for a query through DRPC would be cumbersome and require a lot of logic to handle. A PubSub system was a natural solution to this. Since DRPC was a shared resource per cluster, we also were <a href="../../backend/storm-performance/#test-4-improving-the-maximum-number-of-simultaneous-raw-queries">tying the Backend's scalability</a> to a resource that we didn't control.</p>
<p>However, we didn't want to pick a particular PubSub like Kafka and restrict a user's choice. So, we added a PubSub layer that was generic and entirely pluggable into both the Backend and the Web Service. We would support a select few like <a href="https://github.com/bullet-db/bullet-kafka">Kafka</a> or <a href="https://github.com/bullet-db/bullet-storm">Storm DRPC</a>. See <a href="#implementing-your-own-pubsub">below</a> for how to create your own.</p>
<p>With the transport mechanism abstracted out, it opens up a lot of possibilities like implementing Bullet on other stream processors, allowing for the development of <a href="../../backend/spark-architecture/">Bullet on Spark</a> along with other possible implementations in the future.</p>
<h2 id="what-does-it-do">What does it do?</h2>
<p>A PubSub operates in two contexts:</p>
<ol>
<li>Submitting queries and reading results. This is the <code>QUERY_SUBMISSION</code> context and the PubSub mode for the Web Service</li>
<li>Reading queries and submitting results. This is the <code>QUERY_PROCESSING</code> context and the PubSub mode for the Backend</li>
</ol>
<p>A PubSub provides Publisher and Subscriber instances that, depending on the context it is in, will write and read differently. Publishers in <code>QUERY_SUBMISSION</code> write queries to your PubSub whereas Publishers in <code>QUERY_PROCESSING</code> write results. Similarly, Subscribers in <code>QUERY_SUBMISSION</code> read results, but Subscribers in <code>QUERY_PROCESSING</code> read queries. A Publisher and Subscriber in a particular context make up read and write halves of the <em>pipes</em> for stream of queries and stream of results.</p>
<h3 id="messages">Messages</h3>
<p>The PubSub layer does not deal with queries and results and just works on instances of messages of type <code>com.yahoo.bullet.pubsub.PubSubMessage</code>. These <a href="https://github.com/bullet-db/bullet-core/blob/master/src/main/java/com/yahoo/bullet/pubsub/PubSubMessage.java">PubSubMessages</a> are keyed (<code>id</code> and <code>sequence</code>), store content and metadata. This is a light wrapper around the payload and is tailored to work with multiple results per query and support communicating additional information and signals to and from the PubSub in addition to just queries and results.</p>
<h3 id="serde">SerDe</h3>
<p>The PubSub layer also supports a <code>PubSubMessageSerDe</code> interface to customize how the data is stored in the message. The SerDe is only used for publishing a message from the Web Service and for reading it in the backend. This is particularly relevant if you are storing the PubSubMessage in a <a href="../../ws/setup/#storage-configuration">storage layer</a> for resiliency. Using an appropriate SerDe controls how the payload is serialized and deserialized for transportation and storage. For instance (and by default), the <a href="https://github.com/bullet-db/bullet-core/blob/master/src/main/java/com/yahoo/bullet/pubsub/ByteArrayPubSubMessageSerDe.java">ByteArrayPubSubMessageSerDe</a> is used for queries. This converts the Query object payload into a byte[] when storing and transmitting it to the backend. The backend, however, does not reify the payload back into a Query object till it needs the Query. So the PubSubMessage can be serialized and deserialized multiple times as it is transferred between components without needless conversions back and forth. You can write your own if you wish to customize the behavior and control what is stored in the Storage layer if one is used. For instance, BQL provides a <a href="https://github.com/bullet-db/bullet-bql/blob/master/src/main/java/com/yahoo/bullet/bql/query/LazyPubSubMessageSerDe.java">LazyPubSubMessageSerDe</a> that keeps the query as a String and makes the backend create the Query object using BQL (normally this is done in the API)!</p>
<h2 id="choosing-a-pubsub-implementation">Choosing a PubSub implementation</h2>
<p>If you want to use an implementation already built, we currently support:</p>
<ol>
<li><a href="../kafka/#setup">Kafka</a> for any Backend</li>
<li><a href="../pulsar/#setup">Pulsar</a> for any Backend</li>
<li><a href="../rest/#setup">REST</a> for any Backend</li>
<li><a href="../storm-drpc/#setup">Storm DRPC</a> if you're using Bullet on Storm as your Backend</li>
</ol>
<h2 id="implementing-your-own-pubsub">Implementing your own PubSub</h2>
<p>The core of the PubSub interfaces are defined in the <a href="https://github.com/bullet-db/bullet-core/tree/master/src/main/java/com/yahoo/bullet/pubsub">core Bullet library</a> that you can <a href="../../releases/#bullet-core">depend on</a>.</p>
<p>To create a PubSub, you should extend the abstract class <code>com.yahoo.bullet.pubsub.PubSub</code> and implement the abstract methods for getting instances of Publishers (<code>com.yahoo.bullet.pubsub.Publisher</code>) and Subscribers (<code>com.yahoo.bullet.pubsub.Subscriber</code>). Depending on how you have configured the Web Service and the Backend, they will call the required methods to get the required number of Publishers or Subscribers to parallelize the reading or the writing. You should ensure that they are thread-safe. They will most likely be tied to your units of parallelisms for the underlying PubSub you are invoking.</p>
<p>If you are running sharded instances of your Web Service, you should ensure that your Publishers writing queries add Metadata to the messages to help the Publishers writing results to send the results back to the right Web Service instance that is waiting for them.</p>
<h3 id="reliability">Reliability</h3>
<p>You can choose to make your Publishers and Subscribers as reliable as you want. Both the Web Service and the Backend will call the appropriate reliability methods (<code>commit</code> and <code>fail</code>), but your implementations can choose to be no-ops if you do not want to implement reliability. Alternatively, if you want to make your Subscribers reliable, you could use a simple, in-memory reliable implementation by extending <code>com.yahoo.bullet.pubsub.BufferingSubscriber</code>. This keeps track of uncommitted messages in memory up to a configured threshold (does not read more messages if there are this many uncommitted messages left) and re-emits messages on failures using it.</p>
<h3 id="canonical-example">Canonical example</h3>
<p>For an example of a PubSub implementation, see the <a href="https://github.com/bullet-db/bullet-kafka">Bullet Kafka PubSub project</a>. This is implemented in Java and is a simple implementation that wraps the Kafka client APIs. It supports reliability through the use of the <code>BufferingSubscriber</code> mentioned above. It allows you to specify one or two Kafka topics for queries and results. It can be sharded across multiple Web Service machines using Kafka topic partitions. See the <a href="https://github.com/bullet-db/bullet-kafka/blob/master/src/main/resources/bullet_kafka_defaults.yaml">configuration</a> for details.</p></div>
        
    </div>

    <footer class="col-md-12" >
        <hr />
        <div class="pull-left col-md-6">
            
            
        </div>
        <div class="pull-right col-md-4 text-right">
            <p>
            <small>Bullet is licensed under the <a href='https://github.com/bullet-db/bullet-core/blob/master/LICENSE'>Apache 2 license</a>.<br></small>
            
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
        </div>
    </footer>

    <script src="../../js/jquery-1.10.2.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '../..';
    </script>
    <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
    <script src="../../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
