<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The full documentation for Bullet - A Real Time Data Query Engine"> 
    <meta name="author" content="Akshai Sarma"> 
    <link rel="canonical" href="https://bullet-db.github.io/pubsub/storm-drpc/"> 
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>Storm DRPC - Bullet Docs</title>

    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/extra.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    

    
    
      
    
    
    <style>
        /* Collapse ToC */
        .bs-sidebar .nav .nav {
            display: none;
        }
    </style>
    
</head>

<body data-spy="scroll" data-target=".bs-sidebar">

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Bullet Docs<small class="small small-brand-text">v1.0.0</small></a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Quick Start <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../quick-start/spark/">Spark</a>
</li>

                        
                            
<li >
    <a href="../../quick-start/storm/">Storm</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Backend <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Data Ingestion</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../backend/ingestion/">Record Container</a>
</li>

        
            
<li >
    <a href="../../backend/dsl/">DSL</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Storm</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../backend/storm-architecture/">Architecture</a>
</li>

        
            
<li >
    <a href="../../backend/storm-setup/">Setup</a>
</li>

        
            
<li >
    <a href="../../backend/storm-performance/">Performance</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Spark</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../backend/spark-architecture/">Architecture</a>
</li>

        
            
<li >
    <a href="../../backend/spark-setup/">Setup</a>
</li>

        
            
<li >
    <a href="../../backend/spark-performance/">Performance</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">PubSub <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../architecture/">Architecture</a>
</li>

                        
                            
<li >
    <a href="../kafka/">Kafka</a>
</li>

                        
                            
<li >
    <a href="../rest/">REST</a>
</li>

                        
                            
<li >
    <a href="../pulsar/">Pulsar</a>
</li>

                        
                            
<li class="active">
    <a href="./">Storm DRPC</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Web Service <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../ws/setup/">Setup</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">API</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../ws/api/">BQL</a>
</li>

        
            
<li >
    <a href="../../ws/examples/">Examples</a>
</li>

        
            
<li >
    <a href="../../ws/api-json/">JSON (DEPRECATED)</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">UI <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../ui/setup/">Setup</a>
</li>

                        
                            
<li >
    <a href="../../ui/usage/">Usage</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../releases/">Releases</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../about/contributing/">Contributing</a>
</li>

                        
                            
<li >
    <a href="../../about/contact/">Contact Us</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fa fa-search"></i> Search
                        </a>
                  </li>
                
                
                    <li >
                        <a rel="next" href="../pulsar/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../ws/setup/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/bullet-db">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3">

  

<div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="active">
            <a href="#storm-drpc-pubsub">Storm DRPC PubSub</a>
            <ul class="nav">
                
                    <li class="second-level">
                        <a href="#how-does-it-work">How does it work?</a>
                        
                    </li>
            
                    <li class="second-level">
                        <a href="#setup">Setup</a>
                        <ul class="nav">
                        
                            <li class="third-level">
                                <a href="#plug-into-the-storm-backend">Plug into the Storm Backend</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#plug-into-the-web-service">Plug into the Web Service</a>
                                
                            </li>
                        
                        </ul>
                    </li>
            
                    <li class="second-level">
                        <a href="#caveats-with-storm-drpc">Caveats with Storm DRPC</a>
                        <ul class="nav">
                        
                            <li class="third-level">
                                <a href="#scalability">Scalability</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#query-duration">Query Duration</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#request-response">Request-Response</a>
                                
                            </li>
                        
                            <li class="third-level">
                                <a href="#reliability">Reliability</a>
                                
                            </li>
                        
                        </ul>
                    </li>
            
            </ul>
        </li>
    
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="storm-drpc-pubsub">Storm DRPC PubSub</h1>
<div class="admonition note">
<p class="admonition-title">NOTE: This PubSub only works with old versions of the Storm Backend!</p>
<p>Since DRPC is part of Storm and can only support a single query/response model, this PubSub implementation can only be used with the Storm backend and cannot support Windowed queries (bullet-storm 0.8.0 and later).</p>
</div>
<p>Bullet on <a href="https://storm.apache.org/">Storm</a> can use <a href="http://storm.apache.org/releases/1.0.0/Distributed-RPC.html">Storm DRPC</a> as a PubSub layer. DRPC, or Distributed Remote Procedure Call, is built into Storm and consists of a set of servers that are part of the Storm cluster.</p>
<h2 id="how-does-it-work">How does it work?</h2>
<p>When a Storm topology that uses DRPC is launched, it registers a spout with a unique name (the procedure in the Distributed Remote Procedure Call) with the DRPC infrastructure. The DRPC Servers expose a REST endpoint where data can be POSTed to or a GET request can be made with this unique name. The DRPC infrastructure then sends the request (a query in Bullet) through the spout(s) to the topology that registered that name (Bullet). The result from topology is sent back to the client. We picked Storm to implement Bullet on first not only because it was the most popular Streaming framework at Yahoo but also since DRPC provides us a nice and simple way to handle getting queries into Bullet and sending responses back.</p>
<p>You can communicate with DRPC using <a href="https://thrift.apache.org">Apache Thrift</a> or REST. Our implementation uses REST. The Web Service sends a JSON serialized PubSubMessage with the query in it through HTTP and asynchronously waits for the results back through DRPC.</p>
<div class="admonition note">
<p class="admonition-title">REST and DRPC</p>
<p>While DRPC exposes a <a href="http://thrift.apache.org">Thrift</a> endpoint, the PubSub implementation uses REST. When you launch your topology with the DRPC PubSub, you can POST a JSON Bullet PubSubMessage containing a String JSON query to a DRPC server directly with the function name that you specify in the <a href="#storm-backend">Bullet configuration</a>. For example,
<code>bash
  curl -s -X POST -d '{"id":"", "content":"{}"}' http://&lt;DRPC_SERVER&gt;:&lt;DRPC_PORT&gt;/drpc/&lt;DRPC_FUNCTION_FROM_YOUR_BULLET_CONF&gt;</code>
 to get a random record (inside a JSON representation of a PubSubMessage) from your data instantly if you left the Raw aggregation micro-batch size at the default of 1. The <code>content</code> above in the JSON is the actual (empty) Bullet query. This is a quick way to check if your topology is up and running!</p>
</div>
<h2 id="setup">Setup</h2>
<p>The DRPC PubSub is part of the <a href="../../releases/#bullet-storm">Bullet Storm</a> starting with versions 0.6.2 and above.</p>
<h3 id="plug-into-the-storm-backend">Plug into the Storm Backend</h3>
<p>When you are setting up your Bullet topology with your plug-in data source (a Spout or a topology), you will naturally build a JAR with all the dependencies or a <em>fat</em> JAR. This will include all the DRPC PubSub code and dependencies. You do not need anything else. For configuration, the YAML file that you probably already provide to your topology needs to have the additional settings listed below (the function name is optional but you should change the default since the DRPC function needs to be unique per Storm cluster). Now if you launch your topology, it should be wired up to use Storm DRPC.</p>
<pre><code class="yaml">bullet.pubsub.context.name: &quot;QUERY_PROCESSING&quot;
bullet.pubsub.class.name: &quot;com.yahoo.bullet.storm.drpc.DRPCPubSub&quot;
bullet.pubsub.storm.drpc.function: &quot;custom-name&quot;
</code></pre>

<h4 id="security">Security</h4>
<p>If your Storm  cluster is secured with <code>Kerberos</code> (a standard for Big Data platforms), you will need to periodically refresh your Kerberos TGT and push the credentials to your Storm topology. This is generally done with <code>kinit</code> for your topology user, followed by a <code>storm upload-credentials &lt;TOPOLOGY_NAME&gt;</code>. You would probably run this as a <code>cron</code> task.</p>
<h3 id="plug-into-the-web-service">Plug into the Web Service</h3>
<p>When you're plugging in the DRPC PubSub layer into your Web Service, you will need the Bullet Storm JAR with dependencies that you can download from <a href="../../releases/#bullet-storm">JCenter</a>. The classifier for this JAR is <code>fat</code> if you are depending on it through Maven. You can also download the JAR for the 0.6.2 version directly through <a href="http://jcenter.bintray.com/com/yahoo/bullet/bullet-storm/0.6.2/">JCenter here</a>.</p>
<p>You should then plug in this JAR to your Web Service following the instructions <a href="../../ws/setup/#launch">here</a>.</p>
<p>For configuration, you should <a href="../../ws/setup/#pubsub-configuration">follow the steps here</a> and add the context and class name listed above. You will need to point to your DRPC servers and set the function to the same value you chose <a href="#storm-backend">above</a>. You can configure this and other settings that are explained further in the <a href="https://github.com/bullet-db/bullet-storm/blob/master/src/main/resources/bullet_storm_defaults.yaml">PubSub and PubSub Storm DRPC defaults section</a> in the Bullet Storm defaults file.</p>
<pre><code class="yaml">bullet.pubsub.context.name: &quot;QUERY_SUBMISSION&quot;
bullet.pubsub.class.name: &quot;com.yahoo.bullet.storm.drpc.DRPCPubSub&quot;
bullet.pubsub.storm.drpc.servers:
  - server1
  - server2
  - server3
bullet.pubsub.storm.drpc.function: &quot;custom-name&quot;
bullet.pubsub.storm.drpc.http.protocol: &quot;http&quot;
bullet.pubsub.storm.drpc.http.port: &quot;4080&quot;
bullet.pubsub.storm.drpc.http.path: &quot;drpc&quot;
bullet.pubsub.storm.drpc.http.connect.retry.limit: 3
bullet.pubsub.storm.drpc.http.connect.timeout.ms: 1000
</code></pre>

<h2 id="caveats-with-storm-drpc">Caveats with Storm DRPC</h2>
<h4 id="scalability">Scalability</h4>
<p>DRPC servers are a shared resource per Storm cluster and it may be possible that you have to contend with other topologies in your multi-tenant cluster. While it is horizontally scalable, it does tie the scalability of the Bullet backend to it. If you only have a few DRPC servers in your Storm cluster, you may need to add more to support more simultaneous DRPC requests. We have <a href="../../backend/storm-performance/#conclusion_3">found that</a> each server gives us about ~250 simultaneous queries. There is an Async implementation coming in Storm 2.0 that should increase the throughput.</p>
<h4 id="query-duration">Query Duration</h4>
<p>The maximum time a query can run for depends on the maximum time Storm DRPC request can last in your Storm topology. Generally the default is set to 10 minutes. This means that the <strong>longest query duration possible will be 10 minutes</strong>. The value of this is up to your cluster maintainers.</p>
<h4 id="request-response">Request-Response</h4>
<p>Our PubSub uses DRPC using HTTP REST in a request-response model. This means that it will not support incremental results as it is! We could switch our usage of DRPC to send signals to the topology to fetch results and start queries. Depending on if there is demand, we may support this in our implementation in the future.</p>
<h4 id="reliability">Reliability</h4>
<p>Storm DRPC follows the principle of leaving retries to the DRPC user (in our case, the Bullet web service). At this moment, we have not chosen to add reliability mechanisms to the query publishing, result publishing or result subscribing sides of our DRPC PubSub implementations but the query subscribers do use the <code>BufferingSubscriber</code> mentioned <a href="../architecture/#reliability">here</a>.</p></div>
        
    </div>

    <footer class="col-md-12" >
        <hr />
        <div class="pull-left col-md-6">
            
            
        </div>
        <div class="pull-right col-md-4 text-right">
            <p>
            <small>Bullet is licensed under the <a href='https://github.com/bullet-db/bullet-core/blob/master/LICENSE'>Apache 2 license</a>.<br></small>
            
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
        </div>
    </footer>

    <script src="../../js/jquery-1.10.2.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '../..';
    </script>
    <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
    <script src="../../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
